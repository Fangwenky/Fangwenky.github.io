<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>聆听我们的声音</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="js/api.js" defer></script>
  <style>
    .message-wall {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .message-card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .message-author {
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }
    
    .message-date {
      color: #888;
      font-size: 14px;
    }
    
    .message-content {
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .message-actions {
      display: flex;
      gap: 20px;
    }
    
    .action-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #666;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      color: #ff6b6b;
    }
    
    .comment-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      display: none;
    }
    
    .comment {
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
    }
    
    .comment-content {
      flex: 1;
    }
    
    .comment-author {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .comment-actions {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .input-area {
      margin-top: 15px;
    }
    
    .input-name {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    
    .input-comment {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: none;
      height: 80px;
      margin-bottom: 10px;
    }
    
    .send-btn {
      padding: 8px 20px;
      background-color: #ff6b6b;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .send-btn:hover {
      background-color: #ff5252;
    }
    
    .navigation-btns {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }
    
    .nav-btn {
      padding: 10px 20px;
      background-color: #f0f0f0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .nav-btn:hover {
      background-color: #e0e0e0;
    }
    
    .new-message-form {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 20px;
      margin-top: 40px;
    }
    
    .form-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-item">WE我们</a>
      <div class="dropdown">
        <a href="map.html" class="nav-item">我们去往何方</a>
        <div class="dropdown-content">
          <a href="Beijing.html" class="dropdown-item">北京</a>
          <a href="Shanghai.html" class="dropdown-item">上海</a>
          <a href="Heilongjiang.html" class="dropdown-item">黑龙江</a>
          <a href="Jiangsu.html" class="dropdown-item">江苏</a>
          <a href="Zhejiang.html" class="dropdown-item">浙江</a>
          <a href="Fujian.html" class="dropdown-item">福建</a>
          <a href="Henan.html" class="dropdown-item">河南</a>
          <a href="Liaoning.html" class="dropdown-item">辽宁</a>
        </div>
      </div>
      <a href="words.html" class="nav-item active">聆听我们的声音</a>
    </div>
  </nav>
  
  <section>
    <h1>留言墙</h1>
    <p>在这里，我们可以互相倾听和交流</p>
    
    <div class="message-wall">
      <div class="message-card" id="featured-message">
        <div class="message-header">
          <div class="message-author">房砖砖</div>
          <div class="message-date">2025年7月21日 03:05</div>
        </div>
        <div class="message-content">
          <p>
            写下这些话的时候，正是又一年高考录取的季节，也许你已经忘了去年此刻的心情，高考的悲喜或许在一年后的今天
            看起来早已无关紧要。
          </p>
          <p>
            一年前的我建立了第一版的蹭饭地图网站，如今域名也即将到期，想到有曾经的同学今年也将再次收到新的录取通知书，
            便正好借此机会更新一下这个网站。为了让这个纪念站永存，我决定将它托管在 GitHub Pages 上，
            这样即使未来的某一天我不再维护它，它也能继续存在于互联网的某个角落。或许有一天有人会无意间发现这个网站，
            不过这并不重要，路过的人们不会理解这个网站之于我的意义，我的青春和我会想念的你们。
          </p>
          <p>
            这一年的时光显得匆促而繁忙，有许多同学分别后就再未曾相见，母校和老师们也没来得及回去拜访，于是就这样就在一些难以名状的
            不知是空虚还是繁忙中，度过了大一的时光。偶尔我也会怀念高中的时光，那稍有遗憾却又充满希望的时光。
            每次发觉那青春的底色是与你们在一起的热烈和光明，而非在学业中挣扎的苦痛和孤独，我便会感到欣慰和感激，
            至少在最清澈最简单的岁月里，我选择了与你们一起感受青春的炽热，而非单纯的为了成绩和成功而留下空白且空虚的记忆和人格。
          </p>
          <p>
            不知道如今的你们过得怎么样，希望能常听到你们的消息。我们都有着光耀的青春和前程，祝你们诸事顺遂，前程似锦。
          </p>
          <p>
            我们都有着光耀的青春和前程，祝你们诸事顺遂，前程似锦。
          </p>
          <p>
            也祝愿老师们万事顺意，桃李满天下。
          </p>
          <p>
            感谢点开这个页面的你。
          </p>
        </div>
        <div class="message-actions">
          <div class="action-btn" onclick="likeMessage(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
            </svg>
            <span>点赞</span>
            <span class="like-count">0</span>
          </div>
          <div class="action-btn" onclick="toggleComments(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
            </svg>
            <span>评论</span>
            <span class="comment-count">0</span>
          </div>
        </div>
        <div class="comment-section">
          <div class="input-area">
            <input type="text" class="input-name" placeholder="你的名字">
            <textarea class="input-comment" placeholder="写下你的评论..."></textarea>
            <button class="send-btn" onclick="addComment(this)">发送</button>
          </div>
          <div class="comments-container"></div>
        </div>
      </div>
      
      <div class="navigation-btns">
        <button class="nav-btn" id="prev-btn" onclick="prevMessage()">上一条</button>
        <button class="nav-btn" id="next-btn" onclick="nextMessage()">下一条</button>
      </div>
      
      <div class="new-message-form">
        <h3 class="form-title">留下你的声音</h3>
        <input type="text" class="input-name" id="new-message-name" placeholder="你的名字">
        <textarea class="input-comment" id="new-message-content" placeholder="写下你想说的话..."></textarea>
        <button class="send-btn" onclick="submitNewMessage()">发送</button>
      </div>
    </div>
  </section>
  
  <footer>
    <p>© 2025 2021级1班 · 纪念站</p>
  </footer>
  
  <script>
    let messages = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentMessageIndex = 0;
    let pinnedMessage = null;
    
    // 页面加载时获取留言数据
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // 获取置顶留言
        pinnedMessage = await api.messages.getPinned();
        
        // 获取普通留言
        const result = await api.messages.getAll(currentPage);
        messages = result.messages;
        totalPages = result.totalPages;
        
        // 如果有置顶留言，显示置顶留言
        if (pinnedMessage) {
          displayMessage(pinnedMessage, true);
        } else if (messages.length > 0) {
          // 否则显示第一条普通留言
          displayMessage(messages[0]);
        } else {
          // 没有留言的情况
          const messageCard = document.querySelector('#featured-message');
          messageCard.querySelector('.message-content').innerHTML = '<p>暂无留言</p>';
        }
      } catch (error) {
        console.error('获取留言失败:', error);
        alert('获取留言失败，请稍后再试');
      }
    });
    
    // 显示留言
    function displayMessage(message, isPinned = false) {
      const messageCard = document.querySelector('#featured-message');
      
      messageCard.dataset.messageId = message._id;
      messageCard.querySelector('.message-author').textContent = message.author;
      
      // 格式化日期
      const date = new Date(message.createdAt);
      const formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      messageCard.querySelector('.message-date').textContent = formattedDate;
      
      // 设置内容
      messageCard.querySelector('.message-content').innerHTML = message.content;
      messageCard.querySelector('.like-count').textContent = message.likes;
      
      // 加载评论
      loadComments(message._id);
      
      // 如果是置顶留言，添加标记
      if (isPinned) {
        if (!messageCard.querySelector('.pinned-tag')) {
          const pinnedTag = document.createElement('div');
          pinnedTag.className = 'pinned-tag';
          pinnedTag.textContent = '置顶';
          pinnedTag.style.backgroundColor = '#ff6b6b';
          pinnedTag.style.color = 'white';
          pinnedTag.style.padding = '2px 8px';
          pinnedTag.style.borderRadius = '4px';
          pinnedTag.style.fontSize = '12px';
          pinnedTag.style.marginLeft = '10px';
          
          const messageHeader = messageCard.querySelector('.message-header');
          const messageAuthor = messageCard.querySelector('.message-author');
          messageAuthor.parentNode.insertBefore(pinnedTag, messageAuthor.nextSibling);
        }
      } else {
        const pinnedTag = messageCard.querySelector('.pinned-tag');
        if (pinnedTag) {
          pinnedTag.remove();
        }
      }
    }
    
    // 加载评论
    async function loadComments(messageId) {
      try {
        const comments = await api.comments.getByMessageId(messageId);
        const messageCard = document.querySelector('#featured-message');
        const commentsContainer = messageCard.querySelector('.comments-container');
        const commentCountElement = messageCard.querySelector('.comment-count');
        
        // 更新评论数
        commentCountElement.textContent = comments.length;
        
        // 清空评论容器
        commentsContainer.innerHTML = '';
        
        // 添加评论
        comments.forEach(comment => {
          const commentElement = document.createElement('div');
          commentElement.className = 'comment';
          commentElement.dataset.commentId = comment._id;
          commentElement.innerHTML = `
            <div class="comment-content">
              <div class="comment-author">${comment.author}</div>
              <div>${comment.content}</div>
            </div>
            <div class="comment-actions">
              <div class="action-btn" onclick="likeComment(this)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                </svg>
                <span class="like-count">${comment.likes}</span>
              </div>
            </div>
          `;
          
          commentsContainer.appendChild(commentElement);
        });
      } catch (error) {
        console.error('获取评论失败:', error);
      }
    }
    
    // 点赞留言
    async function likeMessage(element) {
      const messageCard = element.closest('.message-card');
      const messageId = messageCard.dataset.messageId;
      const likeCountElement = element.querySelector('.like-count');
      
      try {
        const result = await api.messages.like(messageId);
        likeCountElement.textContent = result.likes;
      } catch (error) {
        console.error('点赞失败:', error);
        alert('点赞失败，请稍后再试');
      }
    }
    
    // 切换评论区显示/隐藏
    function toggleComments(element) {
      const messageCard = element.closest('.message-card');
      const commentSection = messageCard.querySelector('.comment-section');
      if (commentSection.style.display === 'block') {
        commentSection.style.display = 'none';
      } else {
        commentSection.style.display = 'block';
      }
    }
    
    // 添加评论
    async function addComment(element) {
      const messageCard = element.closest('.message-card');
      const messageId = messageCard.dataset.messageId;
      const nameInput = messageCard.querySelector('.input-name');
      const commentInput = messageCard.querySelector('.input-comment');
      
      const author = nameInput.value.trim();
      const content = commentInput.value.trim();
      
      if (!author || !content) {
        alert('请填写名字和评论内容');
        return;
      }
      
      try {
        await api.comments.submit({
          messageId,
          author,
          content
        });
        
        // 清空输入框
        nameInput.value = '';
        commentInput.value = '';
        
        alert('评论已提交，审核通过后将会显示');
      } catch (error) {
        console.error('提交评论失败:', error);
        alert('提交评论失败，请稍后再试');
      }
    }
    
    // 点赞评论
    async function likeComment(element) {
      const comment = element.closest('.comment');
      const commentId = comment.dataset.commentId;
      const likeCountElement = element.querySelector('.like-count');
      
      try {
        const result = await api.comments.like(commentId);
        likeCountElement.textContent = result.likes;
      } catch (error) {
        console.error('点赞失败:', error);
        alert('点赞失败，请稍后再试');
      }
    }
    
    // 提交新留言
    async function submitNewMessage() {
      const nameInput = document.getElementById('new-message-name');
      const contentInput = document.getElementById('new-message-content');
      
      const author = nameInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!author || !content) {
        alert('请填写名字和留言内容');
        return;
      }
      
      try {
        await api.messages.submit({
          author,
          content
        });
        
        // 清空输入框
        nameInput.value = '';
        contentInput.value = '';
        
        alert('留言已提交，审核通过后将会显示');
      } catch (error) {
        console.error('提交留言失败:', error);
        alert('提交留言失败，请稍后再试');
      }
    }
    
    // 上一条留言
    async function prevMessage() {
      // 如果当前显示的是置顶留言，且有普通留言，则显示最后一条普通留言
      if (pinnedMessage && document.querySelector('#featured-message').dataset.messageId === pinnedMessage._id) {
        if (messages.length > 0) {
          currentMessageIndex = messages.length - 1;
          displayMessage(messages[currentMessageIndex]);
        }
        return;
      }
      
      // 如果当前是第一条留言，且有置顶留言，则显示置顶留言
      if (currentMessageIndex === 0) {
        if (pinnedMessage) {
          displayMessage(pinnedMessage, true);
        } else {
          alert('这是第一条留言');
        }
        return;
      }
      
      // 否则显示上一条留言
      currentMessageIndex--;
      displayMessage(messages[currentMessageIndex]);
    }
    
    // 下一条留言
    async function nextMessage() {
      // 如果当前显示的是置顶留言，则显示第一条普通留言
      if (pinnedMessage && document.querySelector('#featured-message').dataset.messageId === pinnedMessage._id) {
        if (messages.length > 0) {
          currentMessageIndex = 0;
          displayMessage(messages[currentMessageIndex]);
        }
        return;
      }
      
      // 如果当前是最后一条留言，则尝试加载下一页
      if (currentMessageIndex === messages.length - 1) {
        if (currentPage < totalPages) {
          try {
            currentPage++;
            const result = await api.messages.getAll(currentPage);
            messages = messages.concat(result.messages);
            currentMessageIndex++;
            displayMessage(messages[currentMessageIndex]);
          } catch (error) {
            console.error('获取更多留言失败:', error);
            alert('获取更多留言失败，请稍后再试');
            currentPage--;
          }
        } else {
          alert('已经是最后一条留言');
        }
        return;
      }
      
      // 否则显示下一条留言
      currentMessageIndex++;
      displayMessage(messages[currentMessageIndex]);
    }
  </script>
</body>
</html>